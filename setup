#!/usr/bin/env bash

function do_setup() {
  bootstrap
  ssh_save
  finish
}

function bootstrap()
{
  sudo apt-add-repository ppa:ansible/ansible -y > /dev/null 2>&1

  echo '-----> Upgrading and autocleaning packages...'
  sudo apt-get update -qq
  sudo apt-get upgrade -qq --force-yes
  sudo apt-get autoremove -y -qq && sudo aptitude autoclean -q2

  echo '-----> Installing Ansible and git...'
  sudo apt-get install -qq software-properties-common git ansible

  if [ -d "$HOME/.dotfiles" ]; then
    echo '-----> Updating dotfiles...'
    cd $HOME/.dotfiles && git checkout master && git pull
  else
    echo '-----> Cloning dotfiles...'
    git clone https://gitlab.com/phansch/dotfiles.git $HOME/.dotfiles && cd $HOME/.dotfiles
  fi

  default_playbooks=(
    ansible/playbooks/base.yml
    ansible/playbooks/dotfiles.yml
  )
  echo '-----> Running default playbooks...'
  ansible-playbook ${default_playbooks[*]} --ask-become-pass -u $USER

  additional_playbooks=(
    ansible/playbooks/docker.yml
    ansible/playbooks/rvm_tmuxinator.yml
    ansible/playbooks/spotify.yml
    ansible/playbooks/additional_packages.yml
    ansible/playbooks/i3.yml
    ansible/playbooks/qutebrowser.yml
    ansible/playbooks/udev.yml
  )

  cmd="ansible-playbook ${additional_playbooks[*]} --ask-become-pass -u $USER"
  echo "-----> To run the rest of the playbooks:"
  echo $cmd
}

function ssh_save()
{
  read -p "-----> Do you want to add your ssh key to ssh-agent? " yn
  case $yn in
      [y]* ) ssh-add $HOME/.ssh/id_rsa &>/dev/null; break;;
      [n]* ) break;;
      * ) echo "Please answer yes (y) or no (n).";;
  esac
}

function finish()
{
  read -p "-----> Almost done. Do you want to re-login now to complete the setup? " yn
  case $yn in
      [y]* ) xfce4-session-logout --logout; break;;
      [n]* ) exit;;
      * ) echo "Please answer yes (y) or no (n).";;
  esac
}

do_setup
