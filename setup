#!/usr/bin/env bash

aptget='sudo apt-get'

function cleanup()
{
  # Run this before, to get app list: sed -nrs '/^\[Desktop Entry\]/d;/^(\[|Name=|Exec=)/p;${g;p}' /usr/share/applications/*.desktop > ~/Desktop/Names-n-Commands.txt
  echo 'Updating and autocleaning packages..'
  $aptget update -qq
  $aptget autoremove -qq && sudo aptitude autoclean -q2
  $aptget upgrade -y -qq
}

function base_packages()
{
  $aptget install -qq software-properties-common git curl rxvt-unicode tmux virtualbox-5.0 zsh unclutter build-essential libglib2.0-dev xsel silversearcher-ag
}

function dotfiles_setup()
{
  echo 'Configuring dotfiles..'
  cd $HOME/Downloads

  # oh-my-zsh
  wget -q --no-check-certificate https://github.com/robbyrussell/oh-my-zsh/raw/master/tools/install.sh -O - | sh

  # rcm (for installing .dotfiles)
  wget -q https://thoughtbot.github.io/rcm/debs/rcm_1.2.2-2_all.deb
  sudo dpkg -i -E rcm* > /dev/null 2>&1
  $aptget -f -y -qq install

  rm *.deb

  # Setup Dotfiles/Configuration
  sudo chsh -s $(which zsh)

  git clone https://gitlab.com/phansch/dotfiles.git $HOME/.dotfiles && cd $HOME/.dotfiles
  rcup -x README.md -x screenshots

  # Make sure zsh-syntax-highlighting is pulled
  git submodule update --init --recursive

  # Setup Ubuntu Mono Powerline Font
  wget -qP ~/.fonts/ https://github.com/Lokaltog/powerline-fonts/raw/master/UbuntuMono/Ubuntu%20Mono%20derivative%20Powerline.ttf
  sudo fc-cache -fv > /dev/null 2>&1;

  # needed if i3 is used, because 
  ln -s $HOME/.xinitrc $HOME/.xsessionrc
  cd $HOME
}

function packages_setup()
{
  echo 'Installing additional packages..'
  # Add Neovim repo
  sudo add-apt-repository -y ppa:neovim-ppa/unstable > /dev/null 2>&1

  $aptget install -qq neovim

  sudo update-alternatives --install /usr/bin/vi vi /usr/bin/nvim 60
  sudo update-alternatives --install /usr/bin/vim vim /usr/bin/nvim 60
  sudo update-alternatives --install /usr/bin/editor editor /usr/bin/nvim 60
}

function ssh_save()
{
  while true; do
    read -p "Do you want to add your ssh key to ssh-agent?" yn
    case $yn in
        [y]* ) ssh-add ~/.ssh/id_rsa &>/dev/null; break;;
        [n]* ) break;;
        * ) echo "Please answer yes (y) or no (n).";;
    esac
  done
}

function finish()
{
  while true; do
    read -p "Almost done. Do you want to re-login now to complete the setup? " yn
    case $yn in
        [y]* ) xfce4-session-logout --logout; break;;
        [n]* ) exit;;
        * ) echo "Please answer yes (y) or no (n).";;
    esac
  done
}

cleanup
base_packages
dotfiles_setup
packages_setup
ssh_save
finish
