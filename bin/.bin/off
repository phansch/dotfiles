#!/bin/bash

run() {
  daily_review_check
  time_tracking_check

  echo "Opening your journal to update it."

  i3-msg '[instance="urxvt" title="vimwiki"] scratchpad show' &>/dev/null
  ask_for_confirmation "Are you satisfied with todays journal?"

  # If work machine, include the timetracking link and
  # open it.
  if answer_is_yes; then
    j "[$(hostname)] Suspending machine"
    echo "Ok then. Suspending the machine"
    sudo systemctl suspend && ~/.bin/lock.sh
  else
    echo "You could write about what you did today; any ideas, goals, etc."
  fi
}

time_tracking_check() {
  if [[ -v TIME_TRACKING_LINK ]]; then
    ask_for_confirmation "Did you track your time?"
    if ! answer_is_yes; then
      echo "Ok, opening your browser now with the time tracking sheet loaded"
      sleep 1
      sensible-browser "$TIME_TRACKING_LINK"
      i3-msg "[class=Firefox|Nightly] focus"
    fi
  fi
}

daily_review_check() {
  if [[ -v DAILY_REVIEW_LINK ]]; then
    current_hour=$(date +"%H")
    if [[ $current_hour -gt 19 ]]; then
      echo "Opening your browser now with the daily review loaded"
      sleep 1
      sensible-browser "$DAILY_REVIEW_LINK"
      i3-msg "[class=Firefox|Nightly] focus" &>/dev/null
    fi
  fi
}

answer_is_yes() {
  [[ "$REPLY" =~ ^[Yy]$ ]] \
    && return 0 \
    || return 1
}

ask_for_confirmation() {
  printf "%b" "$1 (y/n)"
  read -r -n 1
  printf "%b" "\n"
}

run
