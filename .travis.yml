---
sudo: required

language: python

cache: pip

python:
  - 3.6

env:
  global:
    - USER=root

branches:
  only:
    main

jobs:
  include:
    - stage: test
      name: Molecule role part 1
      install: |
        pip3 install virtualenv
        virtualenv virtenv
        source virtenv/bin/activate

        pip3 install -r requirements.txt
      script: |
        source virtenv/bin/activate

        cd ansible/roles/markdown_mimetype && molecule test && cd -
        cd ansible/roles/i3 && molecule test && cd -
        cd ansible/roles/rust && molecule test && cd -
    - stage: test
      name: Molecule role part 2
      install: |
        pip3 install virtualenv
        virtualenv virtenv
        source virtenv/bin/activate

        pip3 install -r requirements.txt
      script: |
        source virtenv/bin/activate

        cd ansible/roles/ripgrep && molecule test && cd -
        cd ansible/roles/github_cli && molecule test && cd -
    - stage: test
      name: Basic lints
      install:
        - docker build -t dotfiles .
      script:
        # yamllint disable-line rule:line-length
        - docker run dotfiles /bin/bash -c "./setup -s && source .venv/bin/activate && ./test/vim && ./test/yaml && ./test/shellcheck"
    - stage: test
      name: Full setup test
      install:
        - docker build -t dotfiles .
      script:
        - docker run dotfiles /bin/bash -c "./setup -a && source .venv/bin/activate && ./test/ansible && ./test/i3"
